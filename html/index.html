<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/jpg" href="Imagenes/Imagen.jpg">
<title>Dispositivos</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { 
  background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  color:#fff;
}

h1{
  font-weight:700;
  text-shadow:0 0 15px rgba(0,255,255,0.6);
}

.card { 
  transition:0.4s ease;
  border:none;
  border-radius:15px;
  background:rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  color:#fff;
}

.card:hover { 
  transform:scale(1.05);
  box-shadow:0 0 25px rgba(0,255,255,0.6);
}

.status-on { 
  color:#00ff88; 
  font-weight:bold; 
}

.status-off { 
  color:#ff4d4d; 
  font-weight:bold; 
}

.btn-primary{
  background: linear-gradient(45deg,#00c6ff,#0072ff);
  border:none;
  font-weight:bold;
}

.btn-danger{
  background: linear-gradient(45deg,#ff416c,#ff4b2b);
  border:none;
}

.table{
  background:rgba(255,255,255,0.1);
  color:#fff;
}

.table-dark{
  background:rgba(0,0,0,0.6) !important;
}

.progress{
  height:20px;
  border-radius:20px;
  background:rgba(255,255,255,0.2);
}

.progress-bar{
  background: linear-gradient(90deg,#00f260,#0575e6);
  font-weight:bold;
}

.form-control, .form-select{
  background:rgba(255,255,255,0.2);
  border:none;
  color:#fff;
}

.form-select option {
  background-color: #203a43;
  color: #fff;
}

.form-select option[value=""] {
  color: #aaa;
}
</style>
</head>

<body>

<div class="container mt-4">

<h1 class="text-center mb-4">üåê Dispositivos</h1>

<!-- FORMULARIO -->
<div class="card shadow mb-4">
<div class="card-body">
<h5>‚ûï Agregar Dispositivo</h5>

<form id="deviceForm">
<div class="row g-2">

<div class="col-md-4">
<input id="nombre" class="form-control" placeholder="Nombre del dispositivo" required>
</div>

<div class="col-md-4">
<select id="tipo" class="form-select" required>
<option value="" disabled selected>Selecciona tipo</option>
<option value="Agua">Dispensador de agua</option>
<option value="Riego">Sistema de riego</option>
<option value="Puertas">Puertas y Ventanas inteligentes</option>
</select>
</div>

<div class="col-md-4">
<input id="ubicacion" class="form-control" placeholder="Ubicaci√≥n" required>
</div>

</div>

<div id="extraFields" class="mt-3"></div>

<button class="btn btn-primary mt-3">Guardar</button>
</form>
</div>
</div>

<!-- DISPOSITIVOS -->
<div class="row g-4" id="devicesContainer"></div>

<hr class="my-4">

<!-- TABLA -->
<h3>üìã Historial de acciones</h3>

<button class="btn btn-danger mb-3" onclick="borrarStatus()">üóëÔ∏è Borrar historial</button>

<table class="table table-bordered table-striped">
<thead class="table-dark">
<tr>
<th>Dispositivo</th>
<th>Acci√≥n</th>
<th>Ubicaci√≥n</th>
</tr>
</thead>
<tbody id="statusTable"></tbody>
</table>

<!-- GR√ÅFICA -->
<h3 class="mt-5">üìä Estad√≠sticas de acciones</h3>
<canvas id="statusChart" height="120"></canvas>

</div>

<script>
const deviceForm = document.getElementById("deviceForm");
const nombre = document.getElementById("nombre");
const tipo = document.getElementById("tipo");
const ubicacion = document.getElementById("ubicacion");
const extraFields = document.getElementById("extraFields");
const devicesContainer = document.getElementById("devicesContainer");
const statusTable = document.getElementById("statusTable");

let devices = JSON.parse(localStorage.getItem("devices")) || [];
let logs = JSON.parse(localStorage.getItem("logs")) || [];
let statusChart = null;

function saveData(){
  localStorage.setItem("devices", JSON.stringify(devices));
  localStorage.setItem("logs", JSON.stringify(logs));
}

tipo.addEventListener("change", () => {
  extraFields.innerHTML = "";

  if(tipo.value === "Agua"){
    extraFields.innerHTML = `
      <label>Nivel de agua (%)</label>
      <input id="nivelAgua" class="form-control" type="number" value="100">
    `;
  }

  if(tipo.value === "Riego"){
    extraFields.innerHTML = `
      <label>Nivel de riego (%)</label>
      <input id="humedad" class="form-control" type="number" value="100">
    `;
  }
});

deviceForm.addEventListener("submit", e => {
  e.preventDefault();

  const device = {
    id: Date.now().toString(),
    nombre: nombre.value,
    tipo: tipo.value,
    ubicacion: ubicacion.value,
    estado: false,
    nivelAgua: document.getElementById("nivelAgua")?.value ?? null,
    humedad: document.getElementById("humedad")?.value ?? null
  };

  devices.push(device);
  saveData();
  deviceForm.reset();
  extraFields.innerHTML = "";
  renderDevices();
});

function eliminarDevice(id){
  devices = devices.filter(d => d.id !== id);
  saveData();
  renderDevices();
}

function registrarAccion(device, accionExtra = null){
  logs.unshift({
    nombre: device.nombre,
    accion: accionExtra ?? (device.estado ? "Encendido" : "Apagado"),
    ubicacion: device.ubicacion
  });

  logs = logs.slice(0,10);
  saveData();
}

function toggleDevice(id){
  const d = devices.find(x => x.id === id);

  // Solo permite encender si hay nivel > 0
  if((d.tipo === "Agua" && d.nivelAgua == 0) || (d.tipo === "Riego" && d.humedad == 0)){
    alert("El nivel est√° en 0%. No se puede encender.");
    return;
  }

  d.estado = !d.estado;
  registrarAccion(d);
  saveData();
  renderDevices();
  renderTable();
}

// üîπ Sistema h√≠brido: manual y autom√°tico
function aplicarReglas(){
  let registroHecho = false;

  devices.forEach(d => {
    if(d.estado){ // solo baja si est√° encendido
      if(d.tipo === "Agua" && d.nivelAgua > 0){
        d.nivelAgua = Math.max(0, d.nivelAgua - 1);
        if(d.nivelAgua === 0){
          d.estado = false;
          registrarAccion(d, "Apagado autom√°ticamente");
          registroHecho = true;
        }
      }

      if(d.tipo === "Riego" && d.humedad > 0){
        d.humedad = Math.max(0, d.humedad - 1);
        if(d.humedad === 0){
          d.estado = false;
          registrarAccion(d, "Apagado autom√°ticamente");
          registroHecho = true;
        }
      }
    }
  });

  saveData();

  if(registroHecho){
    renderTable();
  }
}

function renderDevices(){
  devicesContainer.innerHTML = "";

  devices.forEach(d => {

    let progressHTML = "";
    let value = d.nivelAgua ?? d.humedad ?? 0;

    if(d.tipo !== "Puertas"){
      progressHTML = `
        <div class="progress mt-2">
          <div class="progress-bar" style="width:${value}%">
            ${value}%
          </div>
        </div>
      `;
    }

    devicesContainer.innerHTML += `
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-body">
          <h5>${d.nombre}</h5>
          <p><b>Ubicaci√≥n:</b> ${d.ubicacion}</p>
          <p>Estado:
            <span class="${d.estado ? 'status-on' : 'status-off'}">
              ${d.tipo === "Puertas" ? (d.estado ? "Abierto" : "Cerrado") : (d.estado ? "Encendido" : "Apagado")}
            </span>
          </p>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox"
              ${d.estado ? 'checked' : ''}
              onchange="toggleDevice('${d.id}')">
          </div>

          ${progressHTML}

          <button class="btn btn-danger btn-sm mt-3"
          onclick="eliminarDevice('${d.id}')">
          Eliminar
          </button>
        </div>
      </div>
    </div>`;
  });
}

function renderTable(){
  statusTable.innerHTML = "";
  logs.forEach(l => {
    statusTable.innerHTML += `
    <tr>
      <td>${l.nombre}</td>
      <td>${l.accion}</td>
      <td>${l.ubicacion}</td>
    </tr>`;
  });

  renderChart();
}

function borrarStatus(){
  logs = [];
  saveData();
  renderTable();
}

function renderChart() {
  const onCount = logs.filter(l => l.accion.includes("Encendido")).length;
  const offCount = logs.filter(l => l.accion.includes("Apagado")).length;

  const ctx = document.getElementById("statusChart").getContext("2d");

  if (statusChart) statusChart.destroy();

  statusChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Encendidos", "Apagados"],
      datasets: [{
        label: "Acciones registradas",
        data: [onCount, offCount],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "white" } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { color: "white" } },
        x: { ticks: { color: "white" } }
      }
    }
  });
}

// Intervalo cada 2 segundos
setInterval(() => {
  aplicarReglas();
  renderDevices();
}, 2000);

renderDevices();
renderTable();
</script>

<hr class="mt-5">

<footer class="text-center mt-4 mb-3">
  <p style="font-weight:600; text-shadow:0 0 10px rgba(0,255,255,0.7);">
    üíª Elaborado por: Jorge Omar Aldana P√©rez
  </p>
</footer>

</body>
</html>