<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monitoreo IoT Manual</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f4f6f9; }
.card { transition:0.3s; }
.card:hover { transform:scale(1.03); }
.status-on { color:green; font-weight:bold; }
.status-off { color:red; font-weight:bold; }
</style>
</head>

<body>

<div class="container mt-4">

<h1 class="text-center mb-4">üåê Monitoreo IoT</h1>

<!-- FORMULARIO -->
<div class="card shadow mb-4">
<div class="card-body">
<h5>‚ûï Agregar Dispositivo</h5>

<form id="deviceForm">
<div class="row g-2">

<div class="col-md-4">
<input id="nombre" class="form-control" placeholder="Nombre del dispositivo" required>
</div>

<div class="col-md-4">
<select id="tipo" class="form-select" required>
<option value="">Selecciona tipo</option>
<option value="Agua">Dispensador de agua</option>
<option value="Riego">Sistema de riego</option>
<option value="Iluminaci√≥n">Luz inteligente</option>
</select>
</div>

<div class="col-md-4">
<input id="ubicacion" class="form-control" placeholder="Ubicaci√≥n" required>
</div>

</div>

<div id="extraFields" class="mt-3"></div>

<button class="btn btn-primary mt-3">Guardar</button>
</form>
</div>
</div>

<!-- DISPOSITIVOS -->
<div class="row g-4" id="devicesContainer"></div>

<hr class="my-4">

<!-- TABLA -->
<h3>üìã Historial de acciones (Manual)</h3>

<button class="btn btn-danger mb-3" onclick="borrarStatus()">üóëÔ∏è Borrar historial</button>

<table class="table table-bordered table-striped">
<thead class="table-dark">
<tr>
<th>Dispositivo</th>
<th>Acci√≥n</th>
<th>Ubicaci√≥n</th>
<th>Fecha</th>
</tr>
</thead>
<tbody id="statusTable"></tbody>
</table>

</div>

<script>
/* ============================
   VARIABLES DOM
============================ */
const deviceForm = document.getElementById("deviceForm");
const nombre = document.getElementById("nombre");
const tipo = document.getElementById("tipo");
const ubicacion = document.getElementById("ubicacion");
const extraFields = document.getElementById("extraFields");
const devicesContainer = document.getElementById("devicesContainer");
const statusTable = document.getElementById("statusTable");

/* ============================
   STORAGE
============================ */
let devices = JSON.parse(localStorage.getItem("devices")) || [];
let logs = JSON.parse(localStorage.getItem("logs")) || [];

function saveData(){
  localStorage.setItem("devices", JSON.stringify(devices));
  localStorage.setItem("logs", JSON.stringify(logs));
}

/* ============================
   CAMPOS DIN√ÅMICOS
============================ */
tipo.addEventListener("change", () => {
  extraFields.innerHTML = "";

  if(tipo.value === "Agua"){
    extraFields.innerHTML = `
      <label>Nivel de agua (%)</label>
      <input id="nivelAgua" class="form-control" type="number" value="100">
    `;
  }

  if(tipo.value === "Riego"){
    extraFields.innerHTML = `
      <label>Humedad (%)</label>
      <input id="humedad" class="form-control" type="number" value="30">
    `;
  }

  if(tipo.value === "Iluminaci√≥n"){
    extraFields.innerHTML = `
      <label>Intensidad (%)</label>
      <input id="intensidad" class="form-control" type="number" value="50">
    `;
  }
});

/* ============================
   AGREGAR DISPOSITIVO
============================ */
deviceForm.addEventListener("submit", e => {
  e.preventDefault();

  const device = {
    id: Date.now().toString(),
    nombre: nombre.value,
    tipo: tipo.value,
    ubicacion: ubicacion.value,
    estado: false,
    nivelAgua: document.getElementById("nivelAgua")?.value ?? null,
    humedad: document.getElementById("humedad")?.value ?? null,
    intensidad: document.getElementById("intensidad")?.value ?? null
  };

  devices.push(device);
  saveData();

  deviceForm.reset();
  extraFields.innerHTML = "";
  renderDevices();
});

/* ============================
   REGISTRO MANUAL
============================ */
function registrarAccion(device){
  logs.unshift({
    nombre: device.nombre,
    accion: device.estado ? "Encendido" : "Apagado",
    ubicacion: device.ubicacion,
    fecha: new Date().toISOString()
  });

  logs = logs.slice(0,10);
  saveData();
}

/* ============================
   TOGGLE MANUAL
============================ */
function toggleDevice(id){
  const d = devices.find(x => x.id === id);
  d.estado = !d.estado;
  registrarAccion(d);
  saveData();
  renderDevices();
  renderTable();
}

/* ============================
   REGLAS (SOLO SENSORES)
============================ */
function aplicarReglas(){
  devices.forEach(d => {
    if(d.tipo === "Agua" && d.estado){
      d.nivelAgua = Math.max(0, d.nivelAgua - 1);
    }

    if(d.tipo === "Riego"){
      d.humedad = Math.max(0, Math.min(100, d.humedad + (d.estado ? 2 : -1)));
    }

    if(d.tipo === "Iluminaci√≥n" && !d.estado){
      d.intensidad = 0;
    }
  });
  saveData();
}

/* ============================
   RENDER
============================ */
function renderDevices(){
  devicesContainer.innerHTML = "";

  devices.forEach(d => {
    const value = d.nivelAgua ?? d.humedad ?? d.intensidad ?? 0;

    devicesContainer.innerHTML += `
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-body">
          <h5>${d.nombre}</h5>
          <p><b>Ubicaci√≥n:</b> ${d.ubicacion}</p>
          <p>Estado:
            <span class="${d.estado ? 'status-on' : 'status-off'}">
              ${d.estado ? 'Encendido' : 'Apagado'}
            </span>
          </p>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox"
              ${d.estado ? 'checked' : ''}
              onchange="toggleDevice('${d.id}')">
          </div>

          <div class="progress mt-2">
            <div class="progress-bar" style="width:${value}%">
              ${value}%
            </div>
          </div>
        </div>
      </div>
    </div>`;
  });
}

/* ============================
   TABLA
============================ */
function renderTable(){
  statusTable.innerHTML = "";
  logs.forEach(l => {
    statusTable.innerHTML += `
    <tr>
      <td>${l.nombre}</td>
      <td>${l.accion}</td>
      <td>${l.ubicacion}</td>
      <td>${new Date(l.fecha).toLocaleString()}</td>
    </tr>`;
  });
}

function borrarStatus(){
  logs = [];
  saveData();
  renderTable();
}

/* ============================
   REFRESCO
============================ */
setInterval(() => {
  aplicarReglas();
  renderDevices();
}, 2000);

renderDevices();
renderTable();
</script>

</body>
</html>
